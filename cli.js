parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"E6Yn":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ecdsaSignAlg=exports.ecdsaAlg=exports.ecdhAlg=exports.bufferToB64u=exports.b64uToBuffer=void 0,exports.generateECDSAKeyPair=a,exports.generateECDHKeyPair=s,exports.invariant=c,exports.deriveSharedSecret=p,exports.signJWS=y,exports.verifyJWS=u,exports.getJWKthumbprint=d,exports.exportKey=w,exports.exportKeyPair=f,exports.encryptPrivateKey=l,exports.decryptPrivateKey=x,exports.parseJWS=g,exports.parseJWSSync=b,exports.importPrivateKey=m,exports.importPublicKey=h,exports.importKeyPair=A,exports.encryptData=K,exports.decryptData=v;const e=require("jsrsasign"),t=require("./index"),r=e=>Buffer.from(e.replace("-","+").replace("_","/"),"base64");exports.b64uToBuffer=r;const n=e=>Buffer.from(e).toString("base64").replace("+","-").replace("/","_").replace("=","");exports.bufferToB64u=n,exports.ecdhAlg={name:"ECDH",namedCurve:"P-384"},exports.ecdsaAlg={name:"ECDSA",namedCurve:"P-384"};const o=["sign","verify"];exports.ecdsaSignAlg={name:"ECDSA",hash:{name:"SHA-384"}};const i=Symbol("keySymbol");async function a(){const e=await window.crypto.subtle.generateKey(exports.ecdsaAlg,!0,o),r=await d(await w(e.publicKey));return(0,t.setNickname)(r,`${r}/ECDSA`),e}async function s(){const e=await window.crypto.subtle.generateKey(exports.ecdhAlg,!0,["deriveKey","deriveBits"]),r=await d(await w(e.publicKey));return(0,t.setNickname)(r,`${r}/ECDH`),e}function c(e,t){if(!e)throw new Error(t)}async function p(e,t){const r=await window.crypto.subtle.deriveBits({name:exports.ecdhAlg.name,public:t},e,256);return await window.crypto.subtle.importKey("raw",r,{name:"AES-GCM"},!1,["encrypt","decrypt"])}async function y(t,r,n){const o=Math.floor(Date.now()/1e3);t.iat=o;const i=`${(0,e.utf8tob64u)(JSON.stringify(t))}.${(0,e.utf8tob64u)("string"==typeof r?r:JSON.stringify(r))}`,a=await window.crypto.subtle.sign(exports.ecdsaSignAlg,n,(new TextEncoder).encode(i));return`${i}.${(0,e.hextob64u)((0,e.ArrayBuffertohex)(a))}`}async function u(t,r){t.startsWith('"')&&t.endsWith('"')&&(t=t.slice(1,-1));const[n,o,i]=t.split("."),a=`${n}.${o}`;if(!r){let r;try{r=JSON.parse((0,e.b64utoutf8)(n))}catch(s){}if(r&&"jwk"in r&&"object"==typeof r.jwk){return u(t,await h("ECDSA",r.jwk))}return!1}return"kty"in r&&(r=await h("ECDSA",r)),await window.crypto.subtle.verify({name:exports.ecdsaAlg.name,hash:{name:"SHA-384"}},r,(0,e.hextoArrayBuffer)((0,e.b64utohex)(i)),(new TextEncoder).encode(a))}async function d(t){c("EC"===t.kty,"Unsupported key type");const r={crf:t.crv,kty:t.kty,x:t.x,y:t.y},n=(0,e.rstrtohex)(JSON.stringify(r)),o=await window.crypto.subtle.digest("SHA-256",(0,e.hextoArrayBuffer)(n));return`id-${t.alg?`${t.alg}/`:""}${(0,e.hextob64u)((0,e.ArrayBuffertohex)(o))}`}function w(e){return window.crypto.subtle.exportKey("jwk",e)}async function f(e){return{privateKeyJWK:await w(e.privateKey),publicKeyJWK:await w(e.publicKey)}}async function l(e,t){const r=new TextEncoder,n=await window.crypto.subtle.importKey("raw",r.encode(t),{name:"PBKDF2"},!1,["deriveKey"]),o=window.crypto.getRandomValues(new Uint8Array(16)),i=await window.crypto.subtle.deriveKey({name:"PBKDF2",salt:o,iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),a=window.crypto.getRandomValues(new Uint8Array(12)),s=JSON.stringify(e),c=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},i,r.encode(s));return[Buffer.from(c).toString("base64"),Buffer.from(a).toString("base64"),Buffer.from(o).toString("base64")].join(".")}async function x(e,t){const[r,n,o]=e.split(".").map(e=>Uint8Array.from(Buffer.from(e,"base64")));c(r&&n&&o,"Invalid encrypted private key");const i=new TextEncoder,a=await window.crypto.subtle.importKey("raw",i.encode(t),{name:"PBKDF2"},!1,["deriveKey"]),s=await window.crypto.subtle.deriveKey({name:"PBKDF2",salt:o,iterations:1e5,hash:"SHA-256"},a,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),p=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:n},s,r);return JSON.parse((new TextDecoder).decode(p))}async function g(e,t){if(null!==t){c(await u(e,t),"JWS verification failed")}return b(e)}function b(t){c("string"==typeof t,"Expected a string"),t.startsWith('"')&&t.endsWith('"')&&(t=t.slice(1,-1));const[r,n]=t.split("."),o=JSON.parse((0,e.b64utoutf8)(r));let i=(0,e.b64utoutf8)(n);try{i=JSON.parse(i)}catch(a){}return{header:o,payload:i}}async function m(e,t){return await window.crypto.subtle.importKey("jwk",t,"ECDH"===e?exports.ecdhAlg:exports.ecdsaAlg,!0,"ECDH"===e?["deriveKey","deriveBits"]:["sign"])}async function h(e,t){return await window.crypto.subtle.importKey("jwk",t,"ECDH"===e?exports.ecdhAlg:exports.ecdsaAlg,!0,"ECDH"===e?[]:["verify"])}async function A(e,t="ecdh"){return{privateKey:await window.crypto.subtle.importKey("jwk",e.privateKeyJWK,"ecdh"===t?exports.ecdhAlg:exports.ecdsaAlg,!0,"ecdh"===t?["deriveKey","deriveBits"]:["sign"]),publicKey:await window.crypto.subtle.importKey("jwk",e.publicKeyJWK,"ecdh"===t?exports.ecdhAlg:exports.ecdsaAlg,!0,"ecdh"===t?[]:["verify"])}}const S=30;async function K(t,r){try{const o=window.crypto.getRandomValues(new Uint8Array(12));let i=JSON.stringify({m:r});i.length<S&&(i=JSON.stringify({random:(0,e.ArrayBuffertohex)(window.crypto.getRandomValues(new Uint8Array(S/2)).buffer),m:r}));const a=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:o},t,(new TextEncoder).encode(i));return{iv:Buffer.from(o).toString("base64"),encrypted:(0,exports.bufferToB64u)(a)}}catch(n){throw new Error("Failed to encrypt "+(null==n?void 0:n.message))}}async function v(e,t,r){try{var n;const i=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:(0,exports.b64uToBuffer)(t)},e,(0,exports.b64uToBuffer)(r)),a=(new TextDecoder).decode(i),s=JSON.parse(a);return null!==(n=null==s?void 0:s.m)&&void 0!==n?n:s}catch(o){throw new Error("Failed to decrypt "+(null==o?void 0:o.message))}}
},{"./index":"jF8P"}],"PSPM":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.synAck=e;const n=require("./index");function e(e,s){if("syn"in e)if(void 0===s.syn)s.syn=e.syn;else{if(e.syn!==(0,n.incMessageId)(s.syn))throw new Error(`Syn out of order ${e.syn} - Expected: ${(0,n.incMessageId)(s.syn)}`);s.syn=e.syn}else if(s.minAck&&s.maxAck)if(e.ack===(0,n.incMessageId)(s.maxAck))s.maxAck=e.ack,e.ack===(0,n.incMessageId)(s.minAck)&&(s.minAck=e.ack);else if(e.ack===(0,n.incMessageId)(s.minAck))s.minAck=e.ack;else{if(e.ack<=s.minAck||e.ack===s.maxAck)return!1;if(!(e.ack>s.maxAck))throw new Error(`Ack out of order ${JSON.stringify(e)} ${JSON.stringify(s)}`);{const n=parseInt(s.minAck,16),i=parseInt(e.ack,16);if(i-n>=s.windowSize)throw new Error(`Missing ${i-n} messages between ${s.minAck} and ${e.ack}`);if(0===s.missing.length)for(let e=n+1;e<i;e++)s.missing.push(e.toString(16));const c=s.missing.findIndex(n=>n===e.ack);-1!==c&&s.missing.splice(c,1),s.maxAck=e.ack}}else s.minAck=e.ack,s.maxAck=e.ack;return!0}
},{"./index":"jF8P"}],"jF8P":[function(require,module,exports) {
"use strict";function t(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,a)}return i}function e(e){for(var a=1;a<arguments.length;a++){var r=null!=arguments[a]?arguments[a]:{};a%2?t(Object(r),!0).forEach(function(t){i(e,t,r[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):t(Object(r)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))})}return e}function i(t,e,i){return(e=a(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function a(t){var e=r(t,"string");return"symbol"==typeof e?e:e+""}function r(t,e){if("object"!=typeof t||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var a=i.call(t,e||"default");if("object"!=typeof a)return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.Thumbprint=exports.Client=void 0,exports.setNickname=y,exports.getNickname=p,exports.setMessageIdForTesting=c,exports.incMessageId=g;const n=require("./utils");Object.defineProperty(exports,"Thumbprint",{enumerable:!0,get:function(){return n.Thumbprint}});const s=require("jsrsasign"),o=require("./synAck"),h=new Map;function y(t,e){h.set(t,e)}function p(t){return h.get(t)+"_"+t.substring(t.length-6)}let d;function c(t){d=t}const u=Number.MAX_SAFE_INTEGER/2;class m{async setClientNickname(t){this.clientNickname=t,t&&(y(this.thumbprint,this.clientNickname),y(await(0,n.getJWKthumbprint)(await(0,n.exportKey)(this.storageKeyPair.publicKey)),`storage[${this.clientNickname}]`))}constructor(t,e,a,r){i(this,"storage",void 0),i(this,"thumbprint",void 0),i(this,"identityKeyPair",void 0),i(this,"storageKeyPair",void 0),i(this,"clientNickname",Math.random().toString(36).slice(2)),i(this,"getThreads",()=>{var t;return null!==(t=this.storage.queryItem(`threads:${this.thumbprint}`))&&void 0!==t?t:[]}),i(this,"getInvitationIds",()=>{var t;return null!==(t=this.storage.queryItem(`invitations:${this.thumbprint}`))&&void 0!==t?t:[]}),i(this,"getInvitations",()=>this.getInvitationIds().map(t=>this.storage.getItem(`invitation:${t}`))),i(this,"subscriptions",new Set),this.storage=t,this.thumbprint=e,this.identityKeyPair=a,this.storageKeyPair=r}static async generateClient(t,e){const i=await(0,n.generateECDSAKeyPair)(),a=await(0,n.generateECDHKeyPair)(),r=await(0,n.exportKeyPair)(i),s=await(0,n.exportKeyPair)(a),o=await(0,n.encryptPrivateKey)(r.privateKeyJWK,e),h=await(0,n.encryptPrivateKey)(s.privateKeyJWK,e),y=await(0,n.getJWKthumbprint)(r.publicKeyJWK);return t.setItem(`identity:${y}`,{id:{jwk:r.publicKeyJWK,private:o},storage:{jwk:s.publicKeyJWK,private:h}}),m.loadClient(t,y,e)}static async loadFromBackup(t,e,i){if("string"==typeof e){const a=await(0,n.parseJWS)(e);return m.loadFromBackup(t,a.payload,i)}const a=await(0,n.decryptPrivateKey)(e.identity.id.private,i),r=await(0,n.decryptPrivateKey)(e.identity.storage.private,i),s=await(0,n.importKeyPair)({privateKeyJWK:a,publicKeyJWK:e.identity.id.jwk},"ecdsa"),o=await(0,n.importKeyPair)({privateKeyJWK:r,publicKeyJWK:e.identity.storage.jwk},"ecdh");return await t.loadIdentityBackup(e),new m(t,e.thumbprint,s,o)}static async loadClient(t,e,i){const a=t.getItem(`identity:${e}`);(0,n.invariant)(a,"No identity found for thumbprint");const r=await(0,n.decryptPrivateKey)(a.id.private,i),s=await(0,n.importKeyPair)({privateKeyJWK:r,publicKeyJWK:a.id.jwk},"ecdsa"),o=await(0,n.importKeyPair)({privateKeyJWK:await(0,n.decryptPrivateKey)(a.storage.private,i),publicKeyJWK:a.storage.jwk},"ecdh");return new m(t,e,s,o)}async decryptFromSelf(t){const e=await(0,n.parseJWS)(t,this.identityKeyPair.publicKey),i=await(0,n.importPublicKey)("ECDH",e.header.epk),a=await(0,n.deriveSharedSecret)(this.storageKeyPair.privateKey,i);return await(0,n.decryptData)(a,e.header.iv,e.payload)}async encryptToSelf(t){const e=await(0,n.generateECDHKeyPair)(),i=await(0,n.exportKeyPair)(e),a=await(0,n.deriveSharedSecret)(e.privateKey,this.storageKeyPair.publicKey),{iv:r,encrypted:s}=await(0,n.encryptData)(a,t),o={header:{alg:"ES384",jwk:(await(0,n.exportKeyPair)(this.identityKeyPair)).publicKeyJWK,iat:0,sub:"self-encrypted",iv:r,epk:i.publicKeyJWK},payload:s},h=await(0,n.signJWS)(o.header,o.payload,this.identityKeyPair.privateKey);(0,n.invariant)(await(0,n.verifyJWS)(h),"Error encrypting message");const y=await this.decryptFromSelf(h);return(0,n.invariant)(y,"Decrypted message is empty"),(0,n.invariant)(y===t||t===JSON.stringify(y),"Decrypted message mismatch"),h}async createInvitation({note:t,nickname:e}){var i,a;const{thumbprint:r,jwks:s}=await this.makeThreadKeys(),o={header:{alg:"ES384",jwk:(await(0,n.exportKeyPair)(this.identityKeyPair)).publicKeyJWK,iat:0,sub:"grid-invitation"},payload:{messageId:Number(null!==(i=d)&&void 0!==i?i:Math.floor(Math.random()*u)).toString(16),epk:s.publicKeyJWK,note:t,nickname:e}},h=await(0,n.signJWS)(o.header,o.payload,this.identityKeyPair.privateKey);return this.storage.setItem(`invitation:${r}`,h),this.storage.appendItem(`invitations:${this.thumbprint}`,r,{unique:!0}),this.storage.setItem(`threads:${this.thumbprint}`,null!==(a=this.storage.queryItem(`threads:${this.thumbprint}`))&&void 0!==a?a:[]),this.notifySubscribers(),h}async replyToInvitation(t,e,i,{setMyRelay:a}={}){(0,n.invariant)(await(0,n.verifyJWS)(t),"Invalid invitation signature");const r=await(0,n.parseJWS)(t),s=await this.startThread(t,r.payload.epk,r.header.jwk);return this.replyToThread(s,e,{selfSign:!0,nickname:i,setMyRelay:a})}async startThread(t,e,i,a){if(!a){const{thumbprint:t}=await this.makeThreadKeys();a=t}const r=this.storage.getItem(`encrypted-thread-key:${a}`);(0,n.invariant)(r,`Thread key not found ${a}`);const o=await(0,n.getJWKthumbprint)(i);(0,n.invariant)(!a||o!==this.thumbprint,"Cannot start a thread with yourself");const h=[await(0,n.getJWKthumbprint)(e),a].sort(),y=(0,s.ArrayBuffertohex)(await window.crypto.subtle.digest("SHA-256",Buffer.from(h.join(":"))));return this.storage.setItem(`thread-info:${this.thumbprint}:${y}`,{missing:[],windowSize:5,maxAck:void 0,minAck:void 0,syn:void 0,myThumbprint:a,theirEPK:e,signedInvite:t,theirSignature:i,relays:{}}),this.storage.appendItem(`threads:${this.thumbprint}`,y),await this.appendThread(t,y),this.notifySubscribers(),y}getInvitation(t){return this.storage.getItem(`invitation:${t}`)}async makeThreadKeys(){const t=await(0,n.generateECDHKeyPair)(),e=await(0,n.exportKeyPair)(t),i=await(0,n.getJWKthumbprint)(e.publicKeyJWK);y(i,`thread[${this.clientNickname}]`);const a=await this.encryptToSelf(JSON.stringify(e));return this.storage.setItem(`encrypted-thread-key:${i}`,a),{thumbprint:i,jwks:e}}async readThreadSecret(t){const e=this.storage.getItem(`thread-info:${this.thumbprint}:${t}`);(0,n.invariant)(e,"Thread not found");const i=e.theirEPK;(0,n.invariant)(i,`Public key not found ${e.theirEPK}`);const a=this.storage.getItem(`encrypted-thread-key:${e.myThumbprint}`);(0,n.invariant)("string"==typeof a,`Thread key not found ${e.myThumbprint}`);const r=JSON.parse(await this.decryptFromSelf(a)),s=await(0,n.importPublicKey)("ECDH",i),o=await(0,n.importPrivateKey)("ECDH",r.privateKeyJWK);return{secret:await(0,n.deriveSharedSecret)(o,s),epk:r.publicKeyJWK}}async replyToThread(t,i,a){var r;const{secret:s,epk:o}=await this.readThreadSecret(t),h=this.storage.getItem(`thread-info:${this.thumbprint}:${t}`);(0,n.invariant)(h,"Thread not found");const y=null!==(r=h.syn)&&void 0!==r?r:Number(d?parseInt("100000",16)+d:Math.floor(Math.random()*u)).toString(16);(0,n.invariant)("string"==typeof y,`Invalid message id ${y}`);const p=g(y);null!=a&&a.setMyRelay&&(h.relays[this.thumbprint]=a.setMyRelay),(0,n.invariant)(h.minAck,`Missing minAck in "thread-info" ${i}`);let c={header:{iat:0,alg:"ES384",sub:"grid-reply",re:t,iv:"",from:this.thumbprint},payload:{messageId:p,message:i,minAck:h.minAck}};if(this.storage.setItem(`thread-info:${this.thumbprint}:${t}`,h),null!=a&&a.selfSign&&a.nickname){c={header:e(e({},c.header),{},{sub:"reply-to-invite",jwk:await(0,n.exportKey)(this.identityKeyPair.publicKey),invite:await(0,n.getJWKthumbprint)(h.theirEPK),epk:o}),payload:e(e({},c.payload),{},{nickname:a.nickname,messageId:Number(d?parseInt("100000",16)+d:Math.floor(Math.random()*u)).toString(16)})}}null!=a&&a.setMyRelay&&(c.payload.relay=a.setMyRelay);const{iv:m,encrypted:l}=await(0,n.encryptData)(s,c.payload);c.header.iv=m;const v=await(0,n.signJWS)(c.header,l,this.identityKeyPair.privateKey);(0,n.invariant)((0,n.verifyJWS)(v,this.identityKeyPair.publicKey),"Error encrypting message");const b=await(0,n.getJWKthumbprint)(h.theirSignature),K=h.relays[b];return await this.appendThread(v,t),{reply:v,threadId:t,relay:K}}async appendThread(t,i){const a=(0,n.parseJWSSync)(t);if(!i)switch(a.header.sub){case"grid-invitation":throw new Error("Not Implemented");case"reply-to-invite":{const e=(0,n.verifyJWS)(t);(0,n.invariant)(e,"Expected a self-signed message");const r=a;(0,n.invariant)(r.header.epk,"First message must have an epk"),(0,n.invariant)(r.header.invite,'First message must have an "invite" header');const s=r.header.invite,o=this.storage.getItem(`invitation:${s}`);(0,n.invariant)(o,"Invitation not found "+s);const h=await(0,n.parseJWS)(o),y=await(0,n.getJWKthumbprint)(h.payload.epk);i=await this.startThread(o,r.header.epk,r.header.jwk,y)}case"grid-reply":{var r;const e=a;null!==(r=i)&&void 0!==r||(i=e.header.re);const s=this.storage.getItem(`thread-info:${this.thumbprint}:${i}`);let o=!1;return o=e.header.from===this.thumbprint?await(0,n.verifyJWS)(t,this.identityKeyPair.publicKey):await(0,n.verifyJWS)(t,s.theirSignature),(0,n.invariant)(o,"Invalid message signature"),this.appendThread(t,i)}}(0,n.invariant)(i,"Thread not found");const s=await this.decryptMessage(i,t),h=e({},this.storage.getItem(`thread-info:${this.thumbprint}:${i}`)),y=s.fromThumbprint===this.thumbprint;let p;if(p=y?await(0,n.verifyJWS)(t,this.identityKeyPair.publicKey):await(0,n.verifyJWS)(t,h.theirSignature),(0,n.invariant)(p,"Invalid message signature"),(0,o.synAck)(y?{syn:s.messageId}:{ack:s.messageId},h)){var d;const e=null===(d=this.storage.queryItem(`keyed-messages:${this.thumbprint}:${i}`))||void 0===d?void 0:d.messages;(0,n.invariant)(!e||!e.includes(t),`Message already exists in thread ${JSON.stringify({nickname:this.clientNickname,messageId:s.messageId,sub:a.header.sub,threadId:i,messageIndex:null==e?void 0:e.indexOf(t)},null,2)}`),s.relay&&(h.relays[await(0,n.getJWKthumbprint)(h.theirSignature)]=s.relay,s.relay&&s.relay.match(/^https?:\/\/ntfy.sh\/[^.]+$/)&&(h.relays[this.thumbprint]=s.relay)),this.storage.setItem(`thread-info:${this.thumbprint}:${i}`,h),this.storage.storeMessage(this.thumbprint,i,s.messageId,t),this.notifySubscribers()}else console.warn("Skipping message",s.messageId);return{threadId:i,message:s,relay:s.relay}}async decryptThread(t){const e=this.getEncryptedThread(t),i=await Promise.all(e.map(async e=>"string"==typeof e?this.decryptMessage(t,e):e));return i.sort((t,e)=>{if(t.from!==e.from){if(t.minAck&&t.minAck<e.messageId)return 1;if(e.minAck&&e.minAck<t.messageId)return 1}return("invite"===t.type?-1:0)||("invite"===e.type?1:0)||e.iat-t.iat||(t.from===e.from?t.messageId.localeCompare(e.messageId):0)}),i}async decryptMessage(t,e){const i=this.storage.getItem(`thread-info:${this.thumbprint}:${t}`),a=await(0,n.parseJWS)(e,null);if((0,n.invariant)(i,"Thread not found"),"grid-invitation"===a.header.sub){var r;(0,n.invariant)(await(0,n.verifyJWS)(e),"Invalid message signature");const t=a,i=`Invite from ${t.payload.nickname}.\nNote: ${null!==(r=t.payload.note)&&void 0!==r?r:"(none)"}`,s=await(0,n.getJWKthumbprint)(t.header.jwk);return t.payload.nickname&&y(s,t.payload.nickname),{from:p(s),fromThumbprint:s,epkThumbprint:await(0,n.getJWKthumbprint)(t.payload.epk),message:i,type:"invite",iat:t.header.iat,messageId:t.payload.messageId,minAck:void 0}}const s=a,{secret:o}=await this.readThreadSecret(t),h=await(0,n.decryptData)(o,a.header.iv,s.payload),d=s.header.from,c=d===await(0,n.getJWKthumbprint)(i.theirSignature)?await(0,n.getJWKthumbprint)(i.theirEPK):i.myThumbprint;return{from:p(d),fromThumbprint:d,epkThumbprint:c,message:h.message,type:"message",iat:s.header.iat,messageId:h.messageId,minAck:h.minAck,relay:h.relay}}getEncryptedThread(t){return this.storage.readMessages(this.thumbprint,t)}async getThreadInfo(t){const e=this.storage.getItem(`thread-info:${this.thumbprint}:${t}`);return(0,n.invariant)(e,"Thread not found"),{myRelay:e.relays[this.thumbprint],myNickname:p(this.thumbprint),theirNickname:p(await(0,n.getJWKthumbprint)(e.theirSignature))}}async makeBackup(t){const e=await(0,n.exportKeyPair)(this.identityKeyPair),i=await(0,n.exportKeyPair)(this.storageKeyPair),a=await(0,n.encryptPrivateKey)(e.privateKeyJWK,t),r=await(0,n.encryptPrivateKey)(i.privateKeyJWK,t),s=await this.storage.makeIdentityBackup(this.thumbprint,a,r);return(0,n.signJWS)({alg:"ES384",jwk:e.publicKeyJWK},s,this.identityKeyPair.privateKey)}notifySubscribers(){for(const t of this.subscriptions)t()}subscribe(t){var e;return null!==(e=this.subscriptions)&&void 0!==e||(this.subscriptions=new Set),this.subscriptions.add(t),()=>{this.subscriptions.delete(t)}}}function g(t){let e=parseInt(t,16)+1;e>=u&&(e=1),(0,n.invariant)(!Number.isNaN(e),`Invalid message id ${t} ${e}`);const i=e.toString(16);return(0,n.invariant)(!Number.isNaN(i),`Invalid message toString ${t} ${e}`),i}exports.Client=m;
},{"./utils":"E6Yn","./synAck":"PSPM"}],"BEFl":[function(require,module,exports) {
"use strict";function e(e,s,i){return(s=t(s))in e?Object.defineProperty(e,s,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[s]=i,e}function t(e){var t=s(e,"string");return"symbol"==typeof t?t:t+""}function s(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.GridStorage=void 0;const i=require("./utils");class r{constructor(){e(this,"data",new Map),e(this,"hasItem",e=>this.data.has(e)),e(this,"removeItem",e=>(this.data.delete(e),null)),e(this,"queryItem",e=>this.data.get(e)),e(this,"getItem",e=>((0,i.invariant)(this.hasItem(e),`Key ${e} not found in storage.`),this.data.get(e))),e(this,"setItem",(e,t)=>{this.data.set(e,t)}),e(this,"appendItem",(e,t,{unique:s=!1}={})=>{let i=this.queryItem(e);Array.isArray(i)||(i=[]),s&&i.includes(t)||(i.push(t),this.setItem(e,i))})}debugData(){return Object.fromEntries(this.data.entries())}async loadIdentityBackup(e){var t;this.setItem(`identity:${e.thumbprint}`,e.identity),Object.entries(null!==(t=e.invites)&&void 0!==t?t:{}).forEach(([t,s])=>{this.appendItem(`invitations:${e.thumbprint}`,t,{unique:!0}),this.setItem(`invitation:${t}`,s)}),Object.entries(e.encryptedThreadKeys).forEach(([e,t])=>{this.setItem(`encrypted-thread-key:${e}`,t)}),Object.entries(e.threads).forEach(([t,s])=>{const i=t;this.appendItem(`threads:${e.thumbprint}`,i),this.setItem(`thread-info:${e.thumbprint}:${i}`,s.threadInfo),this.setItem(`keyed-messages:${e.thumbprint}:${i}`,s.messages)})}async makeIdentityBackup(e,t,s){var i,r,a;const n=this.getItem(`identity:${e}`),d={};return{thumbprint:e,identity:{id:{jwk:n.id.jwk,private:t},storage:{jwk:n.storage.jwk,private:s}},invites:null===(i=this.queryItem(`invitations:${e}`))||void 0===i?void 0:i.reduce((e,t)=>(e[t]=this.getItem(`invitation:${t}`),d[t]=this.getItem(`encrypted-thread-key:${t}`),e),{}),threads:null!==(r=await(null===(a=this.queryItem(`threads:${e}`))||void 0===a?void 0:a.reduce(async(t,s)=>{const i=await t,r=this.getItem(`thread-info:${e}:${s}`),a=this.getItem(`keyed-messages:${e}:${s}`);return d[r.myThumbprint]=this.getItem(`encrypted-thread-key:${r.myThumbprint}`),i[s]={threadInfo:r,messages:a},i},Promise.resolve({}))))&&void 0!==r?r:{},encryptedThreadKeys:d}}storeMessage(e,t,s,i){var r;const a=null!==(r=this.queryItem(`keyed-messages:${e}:${t}`))&&void 0!==r?r:{min:s,max:s,messages:[]};a.messages.push(i),this.setItem(`keyed-messages:${e}:${t}`,a)}readMessages(e,t){const{messages:s}=this.getItem(`keyed-messages:${e}:${t}`);return s}}exports.GridStorage=r;
},{"./utils":"E6Yn"}],"Uw7m":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.viewEncryptedThread=s;const e=require("@inquirer/prompts"),a=require("./mainClientMenu"),t=require("jsrsasign");async function s(a,l){const n=await a.decryptThread(l),o=await a.getThreadInfo(l);if(o.myRelay){let e;try{console.log(`fetching updates from... ${o.myRelay}`);const t=await fetch(`${o.myRelay}/json?since=all&poll=1`),s=await t.text();await s.trim().split("\n").reduce(async(t,s)=>{var r;await t,null!==(r=e=JSON.parse(s))&&void 0!==r&&r.message&&await a.appendThread(e.message,l).catch(()=>{})},Promise.resolve())}catch(c){console.error(c)}}console.log(`Thread: ${l}\n--------------------------------------------`),n.map(e=>{console.log(`${e.type} From: ${e.from} ${new Date(1e3*e.iat)}\n${e.message}\n--------------------------------------------`)});const i=await(0,e.select)({message:"What would you like to do?",choices:[o.myRelay?{name:"Refresh",value:"refresh"}:null,{name:"Reply",value:"reply"},{name:"Reply (in $EDITOR)",value:"replyEditor"},{name:"Paste encrypted message",value:"paste"},{name:"View message details",value:"viewDetils"},{name:o.myRelay?"Change Relay":"Set Relay",value:"setRelay"},{name:"Back to main menu",value:"back"}].filter(e=>null!=e)});switch(i){case"back":return;case"setRelay":{let s="Are you sure you want to remove your relay? The operation takes effect while sending a message",n="";if(!o.myRelay){const e=window.crypto.getRandomValues(new Uint8Array(16));s=`Use ${n=`https://ntfy.sh/${(0,t.ArrayBuffertohex)(e.buffer)}`} to send future messages? The operation takes effect while sending a message`}if(await(0,e.confirm)({message:s})){const t=await(0,e.select)({message:"What would you like to do?",choices:[{name:"Reply",value:"reply"},{name:"Reply (in $EDITOR)",value:"replyEditor"},{name:"Back to main menu",value:"back"}]});"reply"!==t&&"replyEditor"!==t||await r(a,l,t,{setMyRelay:n})}break}case"replyEditor":case"reply":await r(a,l,i);break;case"paste":{const t=await(0,e.input)({required:!1,message:"Paste the encrypted reply you recieved (leave empty to cancel)"});t&&await a.appendThread(t,l);break}case"viewDetils":{const t=await(0,e.select)({message:"Which message would you like to inspect?",choices:n.map((e,a)=>({name:`From: ${e.from} ${new Date(1e3*e.iat)}\n${e.message}`,value:a}))});if(t>=0){console.log(n[t]);const e=a.getEncryptedThread(l)[t];console.log(e)}}}return s(a,l)}async function r(t,s,r,l={}){const n="reply"===r?e.input:e.editor,o=await n({required:!1,message:"Enter your message. (leave empty to cancel)"});if(o){const{reply:e,relay:r}=await t.replyToThread(s,o,{setMyRelay:l.setMyRelay});await(0,a.displayRawMessage)(e,r)}}
},{"./mainClientMenu":"p838"}],"p838":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.mainClientMenu=i,exports.displayRawMessage=r;const e=require("@inquirer/prompts"),t=require("./viewEncryptedThread"),a=require("../client/utils"),n=require("jsrsasign");async function i(a){const n=a.getInvitationIds(),i=a.getThreads();console.clear();const r=await(0,e.rawlist)({message:"What would you like to do?",choices:[{name:"Create Invitation",value:"createInvitation"},...n.map(e=>({name:`View Invitation: ${e}`,value:e})),{name:"Reply to Invitation",value:"replyToInvitation"},...i.map(e=>({name:`View Thread: ${e}`,value:e})),{name:"Exit",value:"exit"}]});if("exit"===r?process.exit(0):"createInvitation"===r?await o(a):"replyToInvitation"===r&&await s(a),i.includes(r)&&await(0,t.viewEncryptedThread)(a,r),n.includes(r)){const n=a.getInvitation(r);console.log(n);const i=await(0,e.input)({required:!1,message:"If you have received a reply, paste it here, or leave this empty to continue to the main menu"});if(i){const{threadId:e}=await a.appendThread(i);await(0,t.viewEncryptedThread)(a,e)}}}async function o(t){const a=await(0,e.input)({message:"What would you like your nickname to be in this conversation?"}),n=await(0,e.input)({required:!1,message:"(optional) Note to include with the invitation"}),i=await t.createInvitation({note:n,nickname:a});console.log("Invitation created. Share the text below to allow friends to encrypt messages to you."),console.log(i),console.log("\n\n\n")}async function s(i){const o=await(0,e.input)({message:"Paste the invitation here"});if(!o)return;if(!(await(0,a.verifyJWS)(o)))return void console.log("Invalid invite");const s=(0,a.parseJWSSync)(o),c=await(0,a.getJWKthumbprint)(s.payload.epk);console.log(`Invitation Thumbprint: ${c}`),console.log(`Nickname: ${s.payload.nickname}`),console.log(`Note: ${s.payload.note}`);const l=await(0,e.input)({message:"What would you like your nickname to be in this conversation?",required:!0});let u=void 0;const d=window.crypto.getRandomValues(new Uint8Array(16)),p=`https://ntfy.sh/${(0,n.ArrayBuffertohex)(d.buffer)}`,y=`Use ${p} to send future messages?`;await(0,e.confirm)({message:y})&&(u=p);const m=await(0,e.input)({required:!1,message:"Enter your reply, or leave empty to cancel"});if(m){const{threadId:e,reply:a,relay:n}=await i.replyToInvitation(o,m,l,{setMyRelay:u});return await r(a,n),(0,t.viewEncryptedThread)(i,e)}}async function r(t,a){if(console.log("Here is the message for you to send to the recipient"),console.log(t),a){await(0,e.confirm)({message:`Send message to relay? ${a}`})&&await fetch(a,{method:"POST",body:t}).catch(console.error)}else await(0,e.confirm)({message:"Press enter to continue"})}
},{"./viewEncryptedThread":"Uw7m","../client/utils":"E6Yn"}],"QCba":[function(require,module,exports) {
"use strict";var e,t,r=this&&this.__createBinding||(Object.create?function(e,t,r,i){void 0===i&&(i=r);var a=Object.getOwnPropertyDescriptor(t,r);a&&("get"in a?t.__esModule:!a.writable&&!a.configurable)||(a={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,i,a)}:function(e,t,r,i){void 0===i&&(i=r),e[i]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),a=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)"default"!==a&&Object.prototype.hasOwnProperty.call(e,a)&&r(t,e,a);return i(t,e),t},n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});const o=require("@inquirer/prompts"),s=a(require("path")),u=require("fs"),c=require("../client"),l=require("../client/GridStorage"),d=n(require("crypto")),w=n(require("lodash.debounce")),p=require("./mainClientMenu");async function f(){console.clear();const e=(await u.promises.readdir(".")).filter(e=>e.endsWith(".jws.txt"));if(!(e.length>0)){return"no"===await(0,o.select)({message:"No backup files found. Would you like to create a new identity?",choices:[{name:"Yes",value:"yes"},{name:"No",value:"no"}]})&&process.exit(0),m()}{const r=await(0,o.rawlist)({message:"Which file would you like to open?",choices:[...e.map(e=>({name:s.basename(e,".jws.txt"),value:e})),{value:"newIdentity",name:"Create a new identity"}]});if("newIdentity"===r)return m();const i=await(0,o.password)({message:"Enter pass phrase to decrypt file"}),a=await u.promises.readFile(r,"utf-8");try{const e=await c.Client.loadFromBackup(new l.GridStorage,a,i);for(e.subscribe((0,w.default)(async()=>{const t=await e.makeBackup(i);await u.promises.writeFile(r,t)},500));;)await(0,p.mainClientMenu)(e)}catch(t){console.error("Error loading backup",t),process.exit(1)}}}async function m(){let e="";for(let i=0;i<3;i++){e=await(0,o.password)({message:"Enter pass phrase to encrypt your new identity"});const t=await(0,o.password)({message:"Enter pass phrase again to confirm"});if(e===t)break;console.error("Passwords do not match")}const t=await c.Client.generateClient(new l.GridStorage,e),r=`grid-${t.thumbprint}.jws.txt`;for(t.subscribe((0,w.default)(async()=>{const i=await t.makeBackup(e);await u.promises.writeFile(r,i)},500));;)await(0,p.mainClientMenu)(t)}null!==(t=(e=global).window)&&void 0!==t||(e.window={}),window.crypto=d.default,f();
},{"../client":"jF8P","../client/GridStorage":"BEFl","./mainClientMenu":"p838"}]},{},["QCba"], null)
//# sourceMappingURL=/cli.js.map